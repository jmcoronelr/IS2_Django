<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Plantilla</title>
    <!-- Incluir Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container-custom {
            border: 1px solid #ccc;
            border-radius: 15px;
            padding: 20px;
            background-color: #f1f2f6;
            width: 1233px;
            height: 743px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .content-area {
            border: 1px solid #ccc;
            border-radius: 10px;
            padding: 10px;
            width: 100%;
            height: 500px;
            overflow-y: auto;
            background-color: #f8f9fa;
            position: relative;
        }
        .draggable {
            width: 200px;
            height: 100px;
            border: 1px solid #ccc;
            background-color: #e0e0e0;
            text-align: center;
            line-height: 100px;
            cursor: move;
            position: absolute;
            resize: both;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-light d-flex justify-content-center align-items-center vh-100">
    <div class="container-custom shadow-lg">
        <!-- Iniciar formulario -->
        <form method="POST">
            {% csrf_token %}
            <!-- Encabezado con Estado y Título -->
            <div class="custom-header">
                <div>
                    <label for="estado">Estado:</label>
                    {{ form.estado }}
                </div>
                <div>
                    <input type="text" name="descripcion" value="{{ form.descripcion.value }}" placeholder="Título" class="form-control" style="width: 300px;">
                </div>
            </div>

            <!-- Botones para añadir bloques -->
            <div class="control-buttons">
                <button type="button" class="btn btn-primary" onclick="addTextBlock()">Añadir bloque de texto</button>
                <button type="button" class="btn btn-secondary" onclick="addMultimediaBlock()">Añadir bloque multimedia</button>
                <button type="button" class="btn btn-danger" id="delete-btn" onclick="toggleDeleteMode()">Borrar</button>
                <button type="button" class="btn btn-light" id="cancel-btn" onclick="cancelDeleteMode()" style="display: none;">Cancelar</button>
            </div>

            <!-- Área interactiva para los bloques -->
            <div class="content-area" id="content-area" ondrop="drop(event)" ondragover="allowDrop(event)">
                <!-- Cargar bloques existentes -->
                {% for bloque in bloques %}

                <div class="draggable" 
                    id="block-{{ bloque.id }}" 
                    draggable="true" 
                    style="
                    top: {{ bloque.posicion_top }}; 
                    left: {{ bloque.posicion_left }}; 
                    width: {{ bloque.width }}; 
                    height: {{ bloque.height }};" 
                    ondragstart="drag(event)" 
                    onclick="handleBlockClick(this)">
                    {{ bloque.contenido }}
                </div>     
                
                {% endfor %}
            </div>

            <!-- Botones de pie: Atrás y Guardar Cambios -->
            <div class="footer-buttons">
                <a href="/plantillas/list/" class="btn btn-secondary">← Atrás</a>
                <button type="submit" class="btn btn-primary mx-auto">Guardar Cambios</button>
            </div>

            <!-- Campo oculto para los bloques -->
            <input type="hidden" name="block_data" id="block_data">
        </form>
        <!-- Fin del formulario -->
    </div>

    <!-- Incluir Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentId = 0;
        let deleteMode = false;

        function addTextBlock() {
            const contentArea = document.getElementById('content-area');
            const textBlock = document.createElement('div');
            textBlock.classList.add('draggable');
            textBlock.id = `block-${currentId++}`;
            textBlock.draggable = true;
            textBlock.innerHTML = 'Escribe aquí...';
            textBlock.ondragstart = drag;
            textBlock.onclick = () => handleBlockClick(textBlock);
            contentArea.appendChild(textBlock);
            positionBlock(textBlock, contentArea);
        }

        function addMultimediaBlock() {
            const contentArea = document.getElementById('content-area');
            const mediaBlock = document.createElement('div');
            mediaBlock.classList.add('draggable');
            mediaBlock.id = `block-${currentId++}`;
            mediaBlock.draggable = true;
            mediaBlock.innerHTML = 'Añadir multimedia';
            mediaBlock.ondragstart = drag;
            mediaBlock.onclick = () => handleBlockClick(mediaBlock);
            contentArea.appendChild(mediaBlock);
            positionBlock(mediaBlock, contentArea);
        }

        function positionBlock(block, container) {
            const rect = container.getBoundingClientRect();
            let topPosition = 0;
            let leftPosition = 0;
            block.style.top = `${topPosition}px`;
            block.style.left = `${leftPosition}px`;
        }

        function drag(event) {
            event.dataTransfer.setData("text", event.target.id);
            console.log("Arrastrando bloque con ID:", event.target.id);
        }

        function allowDrop(event) {
            event.preventDefault();
        }

        function drop(event) {
            event.preventDefault();
            const data = event.dataTransfer.getData("text");
            const block = document.getElementById(data);
            const contentArea = document.getElementById('content-area');
            const newLeft = event.clientX - contentArea.getBoundingClientRect().left - block.offsetWidth / 2;
            const newTop = event.clientY - contentArea.getBoundingClientRect().top - block.offsetHeight / 2;
            block.style.left = `${newLeft}px`;
            block.style.top = `${newTop}px`;
        }

        // Modo borrar
        function toggleDeleteMode() {
            deleteMode = !deleteMode;
            console.log("Modo borrar activado:", deleteMode);
            document.getElementById('delete-btn').style.display = 'none';
            document.getElementById('cancel-btn').style.display = 'inline-block';
        }

        // Cancelar modo borrar
        function cancelDeleteMode() {
            deleteMode = false;
            console.log("Modo borrar cancelado");
            document.getElementById('delete-btn').style.display = 'inline-block';
            document.getElementById('cancel-btn').style.display = 'none';
        }

        function handleBlockClick(block) {
            if (deleteMode) {
                console.log("Eliminando bloque con ID:", block.id);
                block.remove();
            } else {
                console.log("Clic en bloque con ID:", block.id);
            }
        }

        function getBlockData() {
            const blocks = document.querySelectorAll('.draggable');
            let blockData = [];

            blocks.forEach(block => {
                const blockInfo = {
                    type: block.innerHTML.includes('multimedia') ? 'multimedia' : 'texto',
                    content: block.innerHTML,
                    top: block.style.top,
                    left: block.style.left,
                    width: block.style.width,
                    height: block.style.height
                };
                blockData.push(blockInfo);
            });

            return blockData;
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelector('form').onsubmit = function(e) {
                const blockData = getBlockData();
                
                // Crear un input hidden para enviar los datos de los bloques
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'block_data';
                input.value = JSON.stringify(blockData);  // Convertimos los datos a JSON
                this.appendChild(input);

                // El formulario se enviará junto con el input de los bloques
            };
        });
    </script>
</body>
</html>
